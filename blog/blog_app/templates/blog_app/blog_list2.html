<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Blog List</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
</head>

<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Blog List</h2>
            <button id="createBtn" class="btn btn-success">Create New Blog</button>
        </div>

        <table id="blog-table" class="display" style="width: 100%">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Title</th>
                    <th>Content</th>
                    <th>Category</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- DataTables will fill this -->
            </tbody>
        </table>
    </div>

    <!-- Modal for Create/Edit -->
    <div class="modal fade" id="blogModal" tabindex="-1" aria-labelledby="blogModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="blogModalLabel">Blog Form</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Form will be loaded here via AJAX -->
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function () {
            // Initialize DataTable
            const table = $("#blog-table").DataTable({
                processing: true,
                serverSide: true,
                ajax: "{% url 'blog:blog_ajax' %}",
                columns: [
                    { data: "pk" },
                    {
                        data: "title",
                        render: function (data, type, row) {
                            return '<a href="/blog/' + row.pk + '">' + data + "</a>";
                        },
                    },
                    {
                        data: "content",
                        render: function (data, type, row) {
                            return type === "display" && data.length > 100
                                ? data.substr(0, 100) + "..."
                                : data;
                        },
                    },
                    { data: "category" },
                    {
                        data: null,
                        orderable: false,
                        render: function (data, type, row) {
                            return (
                                '<div class="btn-group" role="group">' +
                                '<button data-id="' + row.pk + '" class="btn btn-sm btn-primary edit-btn">Edit</button> ' +
                                '<a href="/blog/delete/' + row.pk + '" class="btn btn-sm btn-danger">Delete</a>' +
                                "</div>"
                            );
                        },
                    },
                ],
            });

            // Create button click handler
            $("#createBtn").on("click", function () {
                loadFormInModal("{% url 'blog:blog_create' %}", "Create New Blog");
            });

            // Edit button click handler (delegated event for dynamically created buttons)
            $("#blog-table").on("click", ".edit-btn", function () {
                const blogId = $(this).data("id");
                loadFormInModal("{% url 'blog:blog_update' pk=0 %}".replace("0", blogId), "Edit Blog");
            });

            // Function to load form in modal via AJAX
            function loadFormInModal(url, title) {
                $("#blogModalLabel").text(title);
                $(".modal-body").html('<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div>');

                // Show modal
                const blogModal = new bootstrap.Modal(document.getElementById('blogModal'));
                blogModal.show();

                // Load form via AJAX
                $.ajax({
                    url: url,
                    type: "GET",
                    success: function (data) {
                        $(".modal-body").html(data);
                        setupFormSubmission();
                    },
                    error: function (xhr, status, error) {
                        $(".modal-body").html('<div class="alert alert-danger">Error loading form: ' + error + '</div>');
                    }
                });
            }

            // Setup form submission via AJAX
            function setupFormSubmission() {
                $("#blogForm").on("submit", function (e) {
                    e.preventDefault();

                    $.ajax({
                        url: $(this).attr("action"),
                        type: $(this).attr("method"),
                        data: $(this).serialize(),
                        success: function (response) {
                            if (response.success) {
                                // Close modal and refresh table
                                bootstrap.Modal.getInstance(document.getElementById('blogModal')).hide();
                                table.ajax.reload();

                                // Show success message
                                $("<div class='alert alert-success'>")
                                    .text(response.message)
                                    .appendTo(".container")
                                    .delay(3000)
                                    .fadeOut(function () { $(this).remove(); });
                            } else {
                                // Show form errors
                                $(".modal-body").html(response.html);
                                setupFormSubmission();
                            }
                        },
                        error: function (xhr, status, error) {
                            $(".modal-body").append('<div class="alert alert-danger mt-3">Error submitting form: ' + error + '</div>');
                        }
                    });
                });
            }
        });
    </script>
</body>

</html>